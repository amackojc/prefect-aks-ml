# Generic metadata about this project
name: flows
prefect-version: 2.13.8

# build section allows you to manage and build docker images
build:
- prefect_docker.deployments.steps.build_docker_image:
    id: build-image
    requires: prefect-docker>=0.4.0
    #image_name: "prefectregistry.azurecr.io/prefect-image"
    image_name: "prefect17245984157znv.azurecr.io/prefect-image"
    tag: t0.1.2
    dockerfile: Dockerfile
    platform: "linux/amd64"

# push section allows you to manage if and how this project is uploaded to remote locations
push:
- prefect_docker.deployments.steps.push_docker_image:
    requires: prefect-docker>=0.4.0
    image_name: "{{ build-image.image_name }}"
    tag: "{{ build-image.tag }}"

pull:
- prefect.deployments.steps.set_working_directory:
    directory: /opt/prefect/prefect-aks/workflows
# the definitions section allows you to define reusable components for your deployments
definitions:
  tags: &common_tags
    - "aks"
  work_pool: &common_work_pool
    name: "aks-prefect"
    job_variables:
      image: "{{ build-image.image }}"
      tolerations:
        - key: "kubernetes.azure.com/scalesetpriority"
          operator: "Equal"
          value: "spot"
          effect: "NoSchedule"
        - key: "environment"
          operator: "Equal"
          value: "prefect"
          effect: "NoSchedule"

      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: "environment"
                operator: "In"
                values:
                - "prefect"
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: "kubernetes.azure.com/scalesetpriority"
                operator: "In"
                values:
                - "spot"

# the deployments section allows you to provide configuration for deploying flows
deployments:
- name: "imbalanced"
  tags: *common_tags
  schedule: null
  entrypoint: "flows/imbalanced.py:imbalanced_pipeline"
  work_pool: *common_work_pool

- name: "imbalanced_smote"
  tags: *common_tags
  schedule: null
  entrypoint: "flows/imbalanced_smote.py:imbalanced_smote_pipeline"
  work_pool: *common_work_pool

- name: "imbalanced_vgg19_smote"
  tags: *common_tags
  schedule: null
  entrypoint: "flows/imbalanced_vgg19_smote.py:imbalanced_vgg19_smote_pipeline"
  work_pool: *common_work_pool
